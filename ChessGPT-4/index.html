<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess with API</title>
    <link rel="stylesheet" href="chessboard-1.0.0.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            /* Add this line */
            flex-direction: column;
            /* Add this line */
            align-items: center;
            /* Add this line */
            justify-content: center;
            /* Add this line */
            min-height: 100vh;
            /* Add this line */
            margin: 0;
            /* Add this line */
            padding: 20px;
            /* Add this line */
        }

        #api-key-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #api-key-container {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        #api-key {
            padding: 5px 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 400px;
        }

        #submit-api-key {
            padding: 5px 20px;
            font-size: 16px;
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #submit-api-key:hover {
            background-color: #005fa3;
        }

        #undo {
            margin-top: 5px;
            padding: 5px 20px;
            font-size: 12px;
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #undo:hover {
            background-color: #005fa3;
        }

        .hidden {
            visibility: hidden;
        }

        #error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .error-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        #chessboard-container {
            display: flex;
            align-items: flex-start;
        }

        #board-and-controls {
            display: flex;
            flex-direction: column;
        }

        #reset-board {
            margin-top: 10px;
            padding: 5px 20px;
            font-size: 16px;
            background-color: #ff4c4c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #reset-board:hover {
            background-color: #d83a3a;
        }

        #history-panel {
            margin-left: 10px;
            width: 100px;
            font-size: 12px;
            font-family: 'Courier New', Courier, monospace;
            overflow-y: auto;
        }

        #move-history {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        footer {
            margin-top: 20px;
            font-size: 14px;
        }

        footer a {
            color: #0077cc;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .description {
            margin-bottom: 20px;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="description" style="width: 600px">
        <h2>ChatGPT Chess</h2>
        <p>
            This page allows you to play chess against OpenAI's ChatGPT. The chessboard is powered by the Chessboard.js
            library, and the chess engine is driven by the ChatGPT API. You can make your moves on the board, and
            ChatGPT will respond with its moves in real-time.
        </p>
        <p><i>Written by GPT-4</i></p>
    </div>

    <div id="chessboard-container">    
        <div id="board-and-controls">
            <div id="board" style="width: 400px"></div>
            <div>
                <button id="undo">Undo</button>
            </div>
        </div>
        <div id="history-panel">
            <ul id="move-history"></ul>
        </div>
        <div id="api-key-overlay">
            <div id="api-key-container">
                <input type="password" id="api-key" placeholder="Enter your OpenAPI key" />
                <button id="submit-api-key">Submit</button>
            </div>
        </div>
        <div id="error-overlay" class="hidden">
            <div class="error-content">
                <div id="error-message"></div>
                <button id="reset-board">Reset Board</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script>
        const boardElement = document.getElementById('board');
        const undoButton = document.getElementById('undo');

        const chess = new Chess();
        const board = ChessBoard('board', {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onMouseoutSquare: onMouseoutSquare,
            onMouseoverSquare: onMouseoverSquare,
            onSnapEnd: onSnapEnd,
        });

        undoButton.addEventListener('click', undoMove);

        const historyPanel = document.getElementById('history-panel');

        const submitApiKeyButton = document.getElementById('submit-api-key');
        submitApiKeyButton.addEventListener('click', () => {
            const apiKey = document.getElementById('api-key').value;
            if (apiKey) {
                const apikeyContainer = document.getElementById('api-key-overlay');
                apikeyContainer.classList.add('hidden')
            } else {
                alert('Please enter a valid API key.');
            }
        });

        const resetBoardButton = document.getElementById('reset-board');

        resetBoardButton.addEventListener('click', () => {
            // Reset the board
            chess.reset();
            board.start();

            updateHistory();

            // Hide the error overlay
            const errorOverlay = document.getElementById('error-overlay');
            errorOverlay.style.visibility = 'hidden';
        });

        function onDragStart(source, piece, position, orientation) {
            if (chess.in_checkmate() === true || chess.in_draw() === true || piece.search(/^b/) !== -1) {
                return false;
            }
        }

        function onDrop(source, target) {
            const move = chess.move({
                from: source,
                to: target,
                promotion: 'q',
            });

            if (move === null) {
                return 'snapback';
            }

            updateBoard();
        }

        function onMouseoverSquare(square, piece) { }

        function onMouseoutSquare(square, piece) { }

        function onSnapEnd() {
            board.position(chess.fen());
        }

        function updateHistory() {
            const moveHistoryElement = document.getElementById('move-history');
            const moveHistory = chess.history();

            // Clear the existing move history
            moveHistoryElement.innerHTML = '';

            // Add the new move history
            let lineIndex = 1;
            for (let i = 0; i < moveHistory.length; i += 2) {
                const listItem = document.createElement('li');

                // Add the user's move
                listItem.textContent = `${lineIndex}. ${moveHistory[i]}`;

                // Add the AI's move, if available
                if (i + 1 < moveHistory.length) {
                    listItem.textContent += ` ${moveHistory[i + 1]}`;
                }

                moveHistoryElement.appendChild(listItem);
                lineIndex++;
            }
        }

        async function updateBoard() {
            const lastMove = chess.history().pop();
            const prompt = `Make a chess move in response to the move "${lastMove}".`;
            const apiKey = document.getElementById('api-key').value;

            const response = await fetch('https://api.openai.com/v1/engines/text-davinci-002/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + apiKey,
                },
                body: JSON.stringify({
                    prompt: prompt,
                    max_tokens: 10,
                    n: 1,
                    stop: null,
                    temperature: 0.5,
                }),
            });

            const data = await response.json();
            const chatGPTMove = data.choices[0].text.trim();

            console.log('Moves: ' + chess.history())
            console.log('ChatGPT responded: ' + data.choices[0].text)

            // Validate and apply the move
            const move = chess.move(chatGPTMove);

            if (move === null) {
                const message = `Invalid move by ChatGPT: ${chatGPTMove}`;
                console.log(message);
                showErrorOverlay(message);
                return;
            }

            board.position(chess.fen());

            updateHistory();
        }

        function showErrorOverlay(message) {
            const errorOverlay = document.getElementById('error-overlay');
            const errorMessage = document.getElementById('error-message');

            errorMessage.textContent = message;
            errorOverlay.style.visibility = 'visible';
        }

        function undoMove() {
            chess.undo();
            board.position(chess.fen());
            updateHistory();
        }
    </script>

    <footer>
        <p>Chessboard powered by <a href="https://chessboardjs.com" target="_blank"
                rel="noopener noreferrer">chessboardjs</a> and <a href="https://github.com/jhlywa/chess.js"
                target="_blank" rel="noopener noreferrer">chess.js</a></p>
    </footer>

</body>

</html>